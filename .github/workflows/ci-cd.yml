name: CI/CD Pipeline

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

env:
  PROJECT_ID: agriguard-ac215
  GKE_CLUSTER: agriguard-cluster
  GKE_ZONE: us-central1
  GCR_REGISTRY: gcr.io/agriguard-ac215

jobs:
  test:
    name: Test and Coverage
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-asyncio
        pip install fastapi uvicorn httpx pandas numpy scikit-learn xgboost requests python-dotenv
        pip install chromadb google-generativeai
        if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi
        if [ -f setup.py ]; then pip install -e . || true; fi
        if [ -f pyproject.toml ]; then pip install -e . || true; fi
    
    - name: Run tests with coverage
      run: |
        pytest --cov --cov-report=xml --cov-report=term-missing
    
    - name: Check coverage threshold
      run: |
        coverage report --fail-under=60
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
      continue-on-error: true
    
    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
      continue-on-error: true

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install linting tools
      run: |
        pip install flake8 black
    
    - name: Run flake8
      run: |
        flake8 api/ rag/rag_service.py rag/seed.py tests/ --max-line-length=120 --extend-ignore=E203,W503 || true
    
    - name: Check black formatting
      run: |
        black --check --line-length=120 api/ rag/ tests/ || true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      security-events: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
    
    - name: Install gke-gcloud-auth-plugin
      run: |
        gcloud components install gke-gcloud-auth-plugin
    
    - name: Configure kubectl
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone=${{ env.GKE_ZONE }} \
          --project=${{ env.PROJECT_ID }}
    
    - name: Verify cluster access
      run: |
        kubectl cluster-info
        kubectl get nodes
    
    - name: Build and push Docker images
      run: |
        gcloud auth configure-docker
        
        echo "Building API service..."
        docker build -t ${{ env.GCR_REGISTRY }}/api:${{ github.sha }} -t ${{ env.GCR_REGISTRY }}/api:latest ./api
        docker push ${{ env.GCR_REGISTRY }}/api:${{ github.sha }}
        docker push ${{ env.GCR_REGISTRY }}/api:latest
        
        echo "Building MCSI service..."
        docker build -t ${{ env.GCR_REGISTRY }}/mcsi:${{ github.sha }} -t ${{ env.GCR_REGISTRY }}/mcsi:latest ./ml_models/mcsi
        docker push ${{ env.GCR_REGISTRY }}/mcsi:${{ github.sha }}
        docker push ${{ env.GCR_REGISTRY }}/mcsi:latest
        
        echo "Building Yield service..."
        docker build -t ${{ env.GCR_REGISTRY }}/yield:${{ github.sha }} -t ${{ env.GCR_REGISTRY }}/yield:latest ./ml_models/yield_prediction
        docker push ${{ env.GCR_REGISTRY }}/yield:${{ github.sha }}
        docker push ${{ env.GCR_REGISTRY }}/yield:latest
        
        echo "Building RAG service..."
        docker build -t ${{ env.GCR_REGISTRY }}/rag:${{ github.sha }} -t ${{ env.GCR_REGISTRY }}/rag:latest ./rag
        docker push ${{ env.GCR_REGISTRY }}/rag:${{ github.sha }}
        docker push ${{ env.GCR_REGISTRY }}/rag:latest
        
        echo "Building Frontend..."
        docker build -t ${{ env.GCR_REGISTRY }}/frontend:${{ github.sha }} -t ${{ env.GCR_REGISTRY }}/frontend:latest ./frontend
        docker push ${{ env.GCR_REGISTRY }}/frontend:${{ github.sha }}
        docker push ${{ env.GCR_REGISTRY }}/frontend:latest
    
    - name: Deploy to Kubernetes
      run: |
        kubectl set image deployment/api api=${{ env.GCR_REGISTRY }}/api:${{ github.sha }} -n agriguard
        kubectl set image deployment/mcsi mcsi=${{ env.GCR_REGISTRY }}/mcsi:${{ github.sha }} -n agriguard
        kubectl set image deployment/yield yield=${{ env.GCR_REGISTRY }}/yield:${{ github.sha }} -n agriguard
        kubectl set image deployment/rag rag=${{ env.GCR_REGISTRY }}/rag:${{ github.sha }} -n agriguard
        kubectl set image deployment/frontend frontend=${{ env.GCR_REGISTRY }}/frontend:${{ github.sha }} -n agriguard
        
        kubectl rollout status deployment/api -n agriguard --timeout=5m
        kubectl rollout status deployment/mcsi -n agriguard --timeout=5m
        kubectl rollout status deployment/yield -n agriguard --timeout=5m
        kubectl rollout status deployment/rag -n agriguard --timeout=5m
        kubectl rollout status deployment/frontend -n agriguard --timeout=5m
    
    - name: Verify deployment
      run: |
        kubectl get pods -n agriguard
        kubectl get services -n agriguard
        echo "âœ… Deployment completed successfully!"
        echo "Application URL: http://34.117.183.74"
