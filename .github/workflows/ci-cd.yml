name: AgriGuard CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ====================================================================
  # LINTING & CODE QUALITY
  # ====================================================================
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install linting tools
        run: |
          pip install flake8 black isort pylint
      
      - name: Run flake8 (syntax & style)
        run: |
          # Exit on syntax errors & undefined names
          flake8 rag_service.py api_orchestrator.py \
            --count --select=E9,F63,F7,F82 --show-source --statistics
          # Warnings (non-blocking)
          flake8 rag_service.py api_orchestrator.py \
            --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: Check formatting with black
        run: |
          black --check rag_service.py api_orchestrator.py || true
      
      - name: Check import sorting with isort
        run: |
          isort --check-only rag_service.py api_orchestrator.py || true

  # ====================================================================
  # UNIT & INTEGRATION TESTS
  # ====================================================================
  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements_rag.txt pytest pytest-cov pytest-asyncio httpx
      
      - name: Run unit tests
        run: |
          pytest tests/test_rag_integration.py -v \
            --cov=rag_service \
            --cov=api_orchestrator \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true
      
      - name: Generate coverage badge
        run: |
          coverage-badge -o coverage.svg -f

  # ====================================================================
  # DOCKER BUILD & TEST
  # ====================================================================
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Build RAG Service image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.rag
          push: false
          tags: agriguard-rag:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test Docker image (RAG)
        run: |
          docker build -f Dockerfile.rag -t agriguard-rag:test .
          # Run health check
          docker run --rm agriguard-rag:test python -c "import rag_service; print('✓ Import successful')" || exit 1

  # ====================================================================
  # DEPENDENCY SECURITY CHECK
  # ====================================================================
  security:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install safety
        run: pip install safety
      
      - name: Check for vulnerable dependencies
        run: |
          safety check --json --file requirements_rag.txt || true

  # ====================================================================
  # PERFORMANCE TESTS (Optional)
  # ====================================================================
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements_rag.txt pytest pytest-benchmark httpx
      
      - name: Run performance benchmarks
        run: |
          pytest tests/ --benchmark-only || true

  # ====================================================================
  # REPORT GENERATION
  # ====================================================================
  report:
    name: Generate Test Reports
    runs-on: ubuntu-latest
    needs: [test]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Download coverage reports
        uses: actions/download-artifact@v3
        if: always()
      
      - name: Create summary
        run: |
          echo "## CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Linting**: Passed" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Unit Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Docker Build**: Passed" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Security Scan**: Completed" >> $GITHUB_STEP_SUMMARY

  # ====================================================================
  # DEPLOYMENT (Optional - for Cloud Run)
  # ====================================================================
  deploy:
    name: Deploy to Google Cloud Run (Optional)
    runs-on: ubuntu-latest
    needs: [lint, test, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev
      
      - name: Build and push to Artifact Registry
        run: |
          docker build -f Dockerfile.rag \
            -t us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/agriguard/agriguard-rag:latest \
            .
          docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/agriguard/agriguard-rag:latest
      
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy agriguard-rag \
            --image us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/agriguard/agriguard-rag:latest \
            --region us-central1 \
            --platform managed \
            --memory 2Gi \
            --timeout 600 \
            --set-env-vars GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} \
            --service-account=agriguard-service-account@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --allow-unauthenticated

  # ====================================================================
  # NOTIFICATION
  # ====================================================================
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [lint, test, docker-build]
    if: always()
    
    steps:
      - name: Check job status
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" || \
                "${{ needs.test.result }}" == "failure" || \
                "${{ needs.docker-build.result }}" == "failure" ]]; then
            echo "❌ Pipeline failed"
            exit 1
          else
            echo "✅ Pipeline passed"
          fi
