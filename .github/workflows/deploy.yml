name: AgriGuard CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  GCP_PROJECT_ID: agriguard-ac215
  GCP_REGION: us-central1
  GKE_CLUSTER: agriguard-cluster
  GKE_NAMESPACE: agriguard
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev/agriguard-ac215/agriguard

jobs:
  # Job 1: Run Tests and Check Coverage
  test:
    name: Test Services
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-asyncio httpx
        pip install fastapi uvicorn pandas numpy scikit-learn xgboost
        pip install google-cloud-storage google-generativeai chromadb

    - name: Run MCSI Service Tests
      run: |
        cd src/mcsi-service
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=term
        
    - name: Run Yield Service Tests
      run: |
        cd src/yield-service
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=term

    - name: Run API Service Tests
      run: |
        cd src/api-service
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=term

    - name: Run RAG Service Tests
      run: |
        cd src/rag-service
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=term

    - name: Generate Coverage Report
      run: |
        pip install coverage
        echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        coverage report >> $GITHUB_STEP_SUMMARY || echo "Coverage report not available" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        files: ./src/*/coverage.xml
        flags: unittests
        name: agriguard-coverage

  # Job 2: Build and Push Docker Images (only on main branch)
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        service: [mcsi-service, yield-service, api-service, rag-service, frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build and Push ${{ matrix.service }}
      run: |
        if [ "${{ matrix.service }}" == "frontend" ]; then
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=http://34.117.183.74/api \
            -t ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service }}:${{ github.sha }} \
            -t ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service }}:latest \
            -f deployment/Dockerfile.frontend \
            frontend/
        else
          docker build \
            -t ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service }}:${{ github.sha }} \
            -t ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service }}:latest \
            -f deployment/Dockerfile.${{ matrix.service }} \
            .
        fi
        
        docker push ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service }}:${{ github.sha }}
        docker push ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service }}:latest

  # Job 3: Deploy to GKE (only on main branch)
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --region=${{ env.GCP_REGION }} \
          --project=${{ env.GCP_PROJECT_ID }}

    - name: Deploy to Kubernetes
      run: |
        # Restart all deployments to pull latest images
        kubectl rollout restart deployment/mcsi -n ${{ env.GKE_NAMESPACE }}
        kubectl rollout restart deployment/yield -n ${{ env.GKE_NAMESPACE }}
        kubectl rollout restart deployment/api -n ${{ env.GKE_NAMESPACE }}
        kubectl rollout restart deployment/rag -n ${{ env.GKE_NAMESPACE }}
        kubectl rollout restart deployment/frontend -n ${{ env.GKE_NAMESPACE }}
        
        # Wait for deployments to complete
        kubectl rollout status deployment/mcsi -n ${{ env.GKE_NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/yield -n ${{ env.GKE_NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/api -n ${{ env.GKE_NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/rag -n ${{ env.GKE_NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/frontend -n ${{ env.GKE_NAMESPACE }} --timeout=5m

    - name: Verify Deployment
      run: |
        echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        kubectl get pods -n ${{ env.GKE_NAMESPACE }} >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        echo "## Service Health Check" >> $GITHUB_STEP_SUMMARY
        HEALTH=$(curl -s http://34.117.183.74/api/health || echo "Health check failed")
        echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
        echo "$HEALTH" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Notify deployment success
      if: success()
      run: |
        echo "âœ… Deployment successful! Application available at http://34.117.183.74"
