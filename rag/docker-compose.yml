version: '3.8'

services:
  # ============================================================================
  # FRONTEND
  # ============================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: agriguard-frontend
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_MCSI_API: http://localhost:8000
      NEXT_PUBLIC_YIELD_API: http://localhost:8001
      NEXT_PUBLIC_RAG_API: http://localhost:8003
      NODE_ENV: development
    depends_on:
      - mcsi
      - yield
      - rag-service
    networks:
      - agriguard
    labels:
      app: "agriguard"
      component: "frontend"

  # ============================================================================
  # MCSI SERVICE (Corn Stress Index)
  # ============================================================================
  mcsi:
    build:
      context: .
      dockerfile: ml-models/mcsi/Dockerfile.mcsi
    container_name: agriguard-mcsi
    ports:
      - "8000:8000"
    environment:
      PORT: 8000
      GCS_BUCKET: agriguard-data-prod
      GCP_PROJECT: agriguard-ac215
      PYTHONUNBUFFERED: 1
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS}:/app/gcp-key.json:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - agriguard
    labels:
      app: "agriguard"
      component: "mcsi-service"

  # ============================================================================
  # YIELD FORECAST SERVICE
  # ============================================================================
  yield:
    build:
      context: .
      dockerfile: ml-models/yield_forecast/Dockerfile.yield
    container_name: agriguard-yield
    ports:
      - "8001:8001"
    environment:
      PORT: 8001
      GCS_BUCKET: agriguard-data-prod
      GCP_PROJECT: agriguard-ac215
      PYTHONUNBUFFERED: 1
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS}:/app/gcp-key.json:ro
    depends_on:
      - mcsi
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - agriguard
    labels:
      app: "agriguard"
      component: "yield-service"

  # ============================================================================
  # API ORCHESTRATOR
  # ============================================================================
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: agriguard-api
    ports:
      - "8002:8002"
    environment:
      PORT: 8002
      MCSI_SERVICE_URL: http://mcsi:8000
      YIELD_SERVICE_URL: http://yield:8001
      RAG_SERVICE_URL: http://rag-service:8003
      PYTHONUNBUFFERED: 1
    depends_on:
      - mcsi
      - yield
      - rag-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - agriguard
    labels:
      app: "agriguard"
      component: "api-orchestrator"

  # ============================================================================
  # CHROMADB - Vector Database for RAG Knowledge Base
  # ============================================================================
  chromadb:
    image: chromadb/chroma:latest
    container_name: agriguard-chromadb
    ports:
      - "8004:8000"
    environment:
      ANONYMIZED_TELEMETRY: "False"
      PERSIST_DIRECTORY: /chroma/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/collections"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - chromadb_data:/chroma/data
    networks:
      - agriguard
    labels:
      app: "agriguard"
      component: "vector-database"

  # ============================================================================
  # RAG SERVICE - Retrieval-Augmented Generation Chatbot
  # ============================================================================
  rag-service:
    build:
      context: .
      dockerfile: rag/Dockerfile.rag
    container_name: agriguard-rag
    ports:
      - "8003:8003"
    environment:
      # GCP Configuration
      GCP_PROJECT: ${GCP_PROJECT:-agriguard-ac215}
      GCP_LOCATION: ${GCP_LOCATION:-us-central1}
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-/app/gcp-key.json}

      # Gemini API Configuration
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GEMINI_MODEL: ${GEMINI_MODEL:-gemini-1.5-pro}

      # ChromaDB Configuration
      CHROMADB_HOST: chromadb
      CHROMADB_PORT: 8000

      # Embedding & Vector Store
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-004}
      EMBEDDING_DIMENSION: ${EMBEDDING_DIMENSION:-768}
      RAG_COLLECTION_NAME: ${RAG_COLLECTION_NAME:-corn-stress-knowledge}
      RAG_TOP_K: ${RAG_TOP_K:-5}
      SIMILARITY_THRESHOLD: ${SIMILARITY_THRESHOLD:-0.5}

      # Service Configuration
      PORT: 8003
      PYTHONUNBUFFERED: 1

    depends_on:
      chromadb:
        condition: service_healthy

    volumes:
      # GCP service account key for local development
      - ${GOOGLE_APPLICATION_CREDENTIALS}:/app/gcp-key.json:ro
      - ./rag/rag_service.py:/app/rag_service.py

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 10s
      timeout: 5s
      retries: 3

    networks:
      - agriguard

    labels:
      app: "agriguard"
      component: "rag-service"

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  chromadb_data:
    driver: local

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  agriguard:
    driver: bridge
